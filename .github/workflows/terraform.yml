name: ReactApp IAC

on:
    push:
      branches: 
        - master
      paths: 
        - terraform/**
    pull_request:
      branches: 
        - master
      paths: 
        - terraform/**

env:
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    BUCKET_TF_STATE: ${{ secrets.BUCKET_TF_STATE }}
    AWS_REGION: us-east-1

jobs:
    terraform:
        name: "Apply Terraform Code Changes"
        runs-on: ubuntu-latest
        defaults:
            run:
                shell: bash
                working-directory: ./terraform
        steps:
        - name: Checkout Source Code 
          uses: actions/checkout@v4

        - name: Setup Terraform with Specified Version
          uses: hashicorp/setup-terraform@v3

        - name: Terraform Init
          id: init
          run: terraform init -backend-config="bucket=${{ env.BUCKET_TF_STATE }}"

        - name: Terraform Format Check
          id: fmt
          run: terraform fmt -check

        - name: Terraform Validate
          id: validate
          run: terraform validate

        - name: Terraform Plan
          id: plan
          run: terraform plan -no-color -input=false -out planfile

        - name: Terraform Apply
          id: apply
          if: github.ref == 'refs/heads/master' && github.event_name == 'push' && steps.plan.outcome == 'success'
          run: terraform apply -auto-approve -input=false -parallelism=1 planfile
